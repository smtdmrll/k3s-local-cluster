<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Establisher - K3s Cluster Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { color: white; font-size: 1.5rem; }
        .navbar div { display: flex; gap: 0.5rem; }
        .navbar a { color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 0.9rem; }
        .navbar a:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }

        .form-card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .form-card h2 { color: #333; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #555; font-weight: 600; font-size: 0.9rem; }
        .form-group .hint { font-weight: 400; color: #999; font-size: 0.8rem; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 0.75rem; border: 2px solid #e1e1e1; border-radius: 8px;
            font-size: 0.95rem; transition: border-color 0.3s; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; font-family: 'Courier New', monospace; font-size: 0.85rem; background: #f8f9fa; }

        .btn { padding: 0.75rem 2rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-launch { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; white-space: nowrap; }
        .btn-launch:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .btn-delete { background: #E74C3C; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 5px; border: none; cursor: pointer; }
        .btn-delete:hover { background: #C0392B; }
        .btn-save { background: linear-gradient(135deg, #3498DB, #2980B9); color: white; padding: 0.5rem 1rem; font-size: 0.85rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save:hover { transform: translateY(-1px); }

        .flash { padding: 0.75rem; border-radius: 5px; margin-bottom: 1rem; text-align: center; }
        .flash.info { background: #e8f4fd; color: #1565C0; }
        .flash.error { background: #fee; color: #c00; }

        /* Saved servers */
        .saved-servers { background: #f0f4ff; border: 2px solid #667eea22; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .saved-servers h4 { color: #667eea; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .server-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .server-chip { display: inline-flex; align-items: center; gap: 0.5rem; background: white; border: 1px solid #ddd; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .server-chip:hover { border-color: #667eea; background: #f0f4ff; }
        .server-chip.active { border-color: #667eea; background: #667eea; color: white; }
        .server-chip .chip-delete { color: #ccc; font-size: 0.7rem; margin-left: 0.2rem; }
        .server-chip:hover .chip-delete { color: #E74C3C; }
        .no-servers { color: #999; font-size: 0.85rem; }

        .save-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
        .save-row input { flex: 1; padding: 0.4rem 0.6rem; font-size: 0.85rem; }

        .apps-card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .apps-card h3 { color: #333; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { color: #666; font-weight: 600; background: #f9f9f9; }
        code { background: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.85rem; }

        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-pending { background: #FFF3E0; color: #E67E22; }
        .badge-creating { background: #E3F2FD; color: #1565C0; animation: pulse 1.5s infinite; }
        .badge-running { background: #E8F5E9; color: #27AE60; }
        .badge-failed { background: #FDEDEC; color: #E74C3C; }
        .badge-deleted { background: #f0f0f0; color: #999; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .url-link { color: #667eea; text-decoration: none; font-weight: 600; }
        .url-link:hover { text-decoration: underline; }

        .info-box { background: #e8f4fd; border-left: 4px solid #667eea; padding: 1rem; margin-top: 1rem; border-radius: 0 5px 5px 0; }
        .info-box p { color: #555; font-size: 0.85rem; line-height: 1.6; }
        .info-box code { background: #dce8f5; }

        .empty-state { text-align: center; padding: 3rem; color: #999; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }

        .launch-row { display: flex; gap: 1rem; align-items: end; margin-top: 0.5rem; }
        .launch-row .form-group { margin-bottom: 0; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>K3s Cluster Manager</h1>
        <div>
            <a href="{{ url_for('dashboard') }}">üìä Dashboard</a>
            <a href="{{ url_for('deploy') }}">üöÄ Deploy Manager</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="flash {% if 'error' in message|lower or 'required' in message|lower %}error{% else %}info{% endif %}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="form-card">
            <h2>üì¶ Image Establisher</h2>
            <p style="color:#666; margin-bottom:1.5rem;">Deploy any Docker image on a remote K3s cluster via SSH ‚Äî instantly with a public URL.</p>

            <!-- Saved Servers -->
            <div class="saved-servers">
                <h4>üíæ Saved Servers <span style="font-weight:400; color:#999;">(click to load)</span></h4>
                <div class="server-chips" id="serverChips">
                    <span class="no-servers" id="noServers">Loading...</span>
                </div>
            </div>

            <form method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Server IP Address</label>
                        <input type="text" name="server_ip" id="serverIp" placeholder="192.168.1.200" required>
                    </div>
                    <div class="form-group" style="display:flex; align-items:end; gap:0.5rem;">
                        <div style="flex:1;">
                            <label>Save Server <span class="hint">(optional)</span></label>
                            <div class="save-row">
                                <input type="text" id="saveName" placeholder="e.g. test-server">
                                <button type="button" class="btn-save" onclick="saveServer()">üíæ Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>SSH Private Key <span class="hint">(paste your private key content)</span></label>
                        <textarea name="ssh_key" id="sshKey" rows="4" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" required></textarea>
                    </div>
                </div>

                <div class="launch-row">
                    <div class="form-group" style="flex:3;">
                        <label>Docker Image Name</label>
                        <input type="text" name="image" placeholder="nginx:alpine, httpd:latest, gcr.io/google-samples/hello-app:1.0" required>
                    </div>
                    <div class="form-group" style="flex:0.7; min-width:100px;">
                        <label>Port <span class="hint">(container)</span></label>
                        <input type="number" name="port" value="80" min="1" max="65535">
                    </div>
                    <button type="submit" class="btn btn-launch">üì¶ Launch</button>
                </div>
            </form>

            <div class="info-box">
                <p>
                    <strong>How it works:</strong> SSH into the target server ‚Üí create a dedicated namespace ‚Üí deploy your image ‚Üí expose via NodePort ‚Üí get a direct URL.<br>
                    <strong>Common images:</strong> <code>nginx:alpine</code> (port 80), <code>httpd:latest</code> (port 80), <code>gcr.io/google-samples/hello-app:1.0</code> (port 8080)
                </p>
            </div>
        </div>

        <div class="apps-card">
            <h3>üóÇÔ∏è Established Apps</h3>
            {% if apps %}
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Image</th>
                        <th>Server</th>
                        <th>Status</th>
                        <th>URL</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in apps %}
                    <tr id="row-{{ a[0] }}">
                        <td>{{ a[0] }}</td>
                        <td><code>{{ a[2] }}</code></td>
                        <td><code>{{ a[8] or '-' }}</code></td>
                        <td><span class="badge badge-{{ a[5] }}" id="status-{{ a[0] }}">{{ a[5] }}</span></td>
                        <td id="url-{{ a[0] }}">
                            {% if a[5] == 'running' and a[6] %}
                                <a href="{{ a[6] }}" target="_blank" class="url-link">{{ a[6] }} ‚Üó</a>
                            {% elif a[5] == 'failed' %}
                                <span style="color:#E74C3C; font-size:0.8rem;">{{ a[6][:80] if a[6] else '' }}</span>
                            {% elif a[5] in ('pending', 'creating') %}
                                <span style="color:#999;">deploying...</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ a[7].strftime('%m/%d %H:%M') if a[7] else '-' }}</td>
                        <td>
                            {% if a[5] in ('running', 'failed', 'creating') %}
                            <form method="POST" action="{{ url_for('establish_delete', est_id=a[0]) }}" style="display:inline;" onsubmit="return confirm('Delete this app?')">
                                <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <div class="icon">üì¶</div>
                <p>No apps established yet. Enter a Docker image and target server above to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Load saved servers
        function loadServers() {
            fetch('/api/servers')
                .then(r => r.json())
                .then(servers => {
                    const container = document.getElementById('serverChips');
                    if (servers.length === 0) {
                        container.innerHTML = '<span class="no-servers">No saved servers. Fill in the form and click üíæ Save.</span>';
                        return;
                    }
                    container.innerHTML = servers.map(s =>
                        `<span class="server-chip" onclick="loadServer(${s.id})" data-id="${s.id}">
                            üñ•Ô∏è ${s.name} <span style="color:#999;">(${s.server_ip})</span>
                            <span class="chip-delete" onclick="event.stopPropagation(); deleteServer(${s.id})">‚úï</span>
                        </span>`
                    ).join('');
                })
                .catch(() => {
                    document.getElementById('serverChips').innerHTML = '<span class="no-servers">Could not load servers.</span>';
                });
        }

        // Load a saved server into the form
        function loadServer(id) {
            fetch('/api/servers/' + id)
                .then(r => r.json())
                .then(s => {
                    document.getElementById('serverIp').value = s.server_ip;
                    document.getElementById('sshKey').value = s.ssh_key;
                    document.getElementById('saveName').value = s.name;
                    document.querySelectorAll('.server-chip').forEach(c => c.classList.remove('active'));
                    const chip = document.querySelector(`.server-chip[data-id="${id}"]`);
                    if (chip) chip.classList.add('active');
                });
        }

        // Save server
        function saveServer() {
            const name = document.getElementById('saveName').value.trim();
            const server_ip = document.getElementById('serverIp').value.trim();
            const ssh_key = document.getElementById('sshKey').value.trim();
            if (!name || !server_ip || !ssh_key) {
                alert('Fill in Server IP, SSH Key, and a name to save.');
                return;
            }
            fetch('/api/servers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, server_ip, ssh_key})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { alert(data.error); return; }
                loadServers();
            });
        }

        // Delete saved server
        function deleteServer(id) {
            if (!confirm('Delete this saved server?')) return;
            fetch('/api/servers/' + id, {method: 'DELETE'})
                .then(() => loadServers());
        }

        // Auto-refresh rows that are pending/creating
        function refreshPending() {
            const rows = document.querySelectorAll('tr[id^="row-"]');
            let hasPending = false;

            rows.forEach(row => {
                const id = row.id.replace('row-', '');
                const statusEl = document.getElementById('status-' + id);
                if (!statusEl) return;
                const st = statusEl.textContent.trim();
                if (st === 'pending' || st === 'creating') {
                    hasPending = true;
                    fetch('/api/establish/' + id + '/status')
                        .then(r => r.json())
                        .then(data => {
                            statusEl.textContent = data.status;
                            statusEl.className = 'badge badge-' + data.status;
                            const urlEl = document.getElementById('url-' + id);
                            if (data.status === 'running' && data.url) {
                                urlEl.innerHTML = '<a href="' + data.url + '" target="_blank" class="url-link">' + data.url + ' ‚Üó</a>';
                            } else if (data.status === 'failed' && data.url) {
                                urlEl.innerHTML = '<span style="color:#E74C3C; font-size:0.8rem;">' + data.url.substring(0, 80) + '</span>';
                            }
                            if (data.status !== 'pending' && data.status !== 'creating') {
                                setTimeout(() => location.reload(), 1000);
                            }
                        })
                        .catch(() => {});
                }
            });

            if (hasPending) setTimeout(refreshPending, 3000);
        }

        // Init
        loadServers();
        refreshPending();
    </script>
</body>
</html>
